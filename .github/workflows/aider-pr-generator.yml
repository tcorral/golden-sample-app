name: Aider Issue Processor

on:
  issues:
    types: [opened, edited, labeled]

jobs:
  process_aider_issue:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'aider')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Aider CLI via pip
        run: |
          python -m pip install --upgrade pip
          python -m pip install aider-install
          aider-install

      - name: Parse issue body for sections
        id: parse_issue
        shell: bash
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"

          # Extract "Description": text between "## Description" and the next markdown header.
          DESCRIPTION=$(echo "$ISSUE_BODY" | awk '/## Description/{flag=1; next} /^## /{if(flag){flag=0}} flag')
          # Extract "Files to modify": text between "## Files to modify" and the next markdown header.
          FILES=$(echo "$ISSUE_BODY" | awk '/## Files to modify/{flag=1; next} /^## /{if(flag){flag=0}} flag')
          # Extract "Acceptance criteria": text from "## Acceptance criteria" to the end.
          ACCEPTANCE=$(echo "$ISSUE_BODY" | awk '/## Acceptance criteria/{flag=1; next} flag')

          echo "ISSUE_TITLE<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "DESCRIPTION<<EOF" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ACCEPTANCE<<EOF" >> $GITHUB_OUTPUT
          echo "$ACCEPTANCE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create branch for Aider changes
        id: create_branch
        run: |
          BRANCH="aider-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: Run Aider
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # Set the model to Anthropics Sonnet 3.7 (alias "sonnet")
          AIDER_MODEL: ${{ secrets.AIDER_MODEL || 'sonnet' }}
        run: |
          # Build the command message from the issue content.
          MESSAGE="Issue Title: ${{ steps.parse_issue.outputs.ISSUE_TITLE }}

            Description:
            ${{ steps.parse_issue.outputs.DESCRIPTION }}

            Acceptance Criteria:
            ${{ steps.parse_issue.outputs.ACCEPTANCE }}"

          echo "Using message:"
          echo "$MESSAGE"

          # If "Files to modify" is provided, clean and resolve the file list.
          if [ -n "${{ steps.parse_issue.outputs.FILES }}" ]; then
            RAW_FILES="${{ steps.parse_issue.outputs.FILES }}"
            # Remove bullet markers (*) and extra whitespace, then collapse to one line.
            CLEAN_FILES=$(echo "$RAW_FILES" | sed 's/^\s*\*\s*//g' | tr '\n' ' ')
            echo "Resolved files to modify: $CLEAN_FILES"
            # Pass the cleaned file list as positional arguments.
            aider --model "$AIDER_MODEL" --message "$MESSAGE" $CLEAN_FILES
          else
            echo "No files provided; analyzing entire repository."
            aider --model "$AIDER_MODEL" --message "$MESSAGE"
          fi

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Aider AI: Apply changes for issue #${{ github.event.issue.number }}" || echo "No changes detected."

      - name: Push branch
        run: |
          git push --set-upstream origin ${{ env.branch }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Aider AI Changes for Issue #${{ github.event.issue.number }}"
          body: "This PR applies the changes suggested by Aider AI for issue #${{ github.event.issue.number }} using Anthropics Sonnet 3.7."
          head: ${{ env.branch }}
          base: main
