name: Aider Auto Code Update

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  process-issue:
    runs-on: ubuntu-latest
    if: contains(join(github.event.issue.labels.*.name, ','), 'aider')
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: sudo apt-get install -y build-essential python3-dev

    - name: Install Python build dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel

    - name: Install Aider
      run: pip install aider-chat boto3
  
    - name: Extract issue sections
      id: extract-sections
      run: |
        # Extract and flatten markdown content
        BODY=$(echo "${{ github.event.issue.body }}" | sed 's/\\r//g')
        
        # Extract components and convert to single line
        DESCRIPTION=$(echo "$BODY" | awk '/## Description/{flag=1; next} /## Files to modify/{flag=0} flag' | tr '\n' ' ' | sed 's/\*\*//g; s/  \+/ /g')
        FILES=$(echo "$BODY" | awk '/## Files to modify/{flag=1; next} /## Acceptance criteria/{flag=0} flag' | sed -e 's/^- //' -e '/^$/d' -e 's/^ *//' | xargs -n 1 sh -c '[ -f "$0" ] && echo "$0"' | tr '\n' ' ')
        ACCEPTANCE=$(echo "$BODY" | awk '/## Acceptance criteria/{flag=1; next} /```|^$/{flag=0} flag' | tr '\n' ' ' | sed 's/\*\*//g; s/  \+/ /g; s/\. /. /g')

        # Create single-line prompt with section markers
        PROMPT="PROBLEM: ${DESCRIPTION} | BEHAVIOR: ${ACCEPTANCE} | FILES: ${FILES} | REQUIREMENTS: Implement all fixes in one pass following Angular best practices, update tests, ensure cookie handling works cross-browser"
        
        echo "$PROMPT" > prompt.txt
        echo "$FILES" > files.txt

    - name: Run Aider
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        FILES=$(tr ' ' '\n' < files.txt | xargs -I{} sh -c '[ -f "{}" ] && echo "{}"' | tr '\n' ' ')
        echo "Validated files: $FILES"
        echo "Final prompt content:"
        cat prompt.txt
        aider --yes --model anthropic/claude-3-7-sonnet-latest $FILES <<< $(cat prompt.txt)

    - name: Debug Aider changes
      run: |
        echo "Current working tree status:"
        git status --porcelain
        echo "Files modified:"
        git diff --name-only

    - name: Check for changes
      id: changes
      run: |
        # Check for both staged and unstaged changes
        git add .
        if ! git diff --quiet || ! git diff --cached --quiet; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected:" 
          git status --porcelain
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        fi
    
    - name: Create branch and commit
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        BRANCH_NAME="aider-fix-${{ github.event.issue.number }}"
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        
        # Create or reset branch
        git checkout -B $BRANCH_NAME

        # Log changes
        git status
        
        # Add all changes explicitly
        git add -A
        git commit -m "Fix: ${{ github.event.issue.title }} (closes #${{ github.event.issue.number }})"
        echo "Commit created:"
        git log -1
  
    - name: Push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git remote -v
        git push origin ${{ env.BRANCH_NAME }} --force-with-lease
        echo "Pushed branch ${{ env.BRANCH_NAME }} to origin"
  
    - name: Verify Remote Branch
      run: |
        git fetch origin ${{ env.BRANCH_NAME }}
        git branch -r
  
    - name: List Remote Branches
      run: git ls-remote --heads origin

    - name: Create Pull Request
      if: steps.changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "fix: ${{ github.event.issue.title }}"
        body: |
          **Automated Fix Summary**
          - Addresses issue #${{ github.event.issue.number }}
          - Implemented by Aider AI assistant
          - Branch: ${{ env.BRANCH_NAME }}
        branch: ${{ env.BRANCH_NAME }}
        base: main
        delete-branch: false
        commit-message: "Apply automated fixes for #${{ github.event.issue.number }}"
        author: "GitHub Actions <actions@github.com>"
        committer: "GitHub Actions <actions@github.com>"
        labels: aider,automated-fix
